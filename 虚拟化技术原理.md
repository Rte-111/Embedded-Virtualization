## 虚拟化技术原理

### I. 虚拟机技术介绍 

#### A. 定义和概述

虚拟机（虚拟计算机系统称为“虚拟机”(VM），它是一种严密隔离且内含操作系统和应用的软件容器。）是一种通过虚拟化技术创建的虚拟计算机系统。它是在物理计算机上模拟出的一个完整的计算机环境，包括虚拟的处理器、内存、硬盘、网络接口等。虚拟机可以运行独立的操作系统和应用程序，与物理计算机上的其他虚拟机以及主机系统相互隔离。

![image-20230724163621387](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230724163621387.png) 

#### B. 虚拟机的作用和优势 

- ##### 封装性

  以虚拟机为粒度的封装使得虚拟机运行环境的保存非常便捷。虚拟机的优秀封装性使得以下应用模式可以很方便地实现。

  (1）虚拟机快照(Snapshot)。将运行中的一个虚拟机的某个时间点的状态抓取下来，就像抓拍一张照片一样。

  (2）虚拟机克隆(Clone)。从一个虚拟机的执行环境复制出一个或多个相同的虚拟机。

  (3）虚拟机挂起(Suspend)。指暂停一个运行中的虚拟机,将其运行环境保存在磁盘上。与之相反﹐虚拟机恢复(Resume)是指将保存在磁盘上的虚拟机运行环境恢复到内存中以继续运行的操作。

  优秀的封装性使得虚拟机的保存更容易,从而在灾难恢复中发挥更大的作用。虚拟机快照和克隆等使得部署各种软件运行环境更容易﹐从而使软件开发的测试和调试更为快捷方便。虚拟化最早起源于服务器虚拟化,目前桌面虚拟化也逐渐开始在企业环境中发展起来。优秀的封装性使得企业中可以方便地进行桌面软件维护管理,从而大大降低了IT的管理维护成本。

- ##### 多实例

  在一个计算机上运行多个虚拟机使得资源的调度更为优化。不同的虚拟机有不同的繁忙和空闲时段，忙闲交错使得单个计算机的系统资源利用率大大提高。

- ##### 隔离

  使用虚拟机，每个应用程序可以在自己的操作系统环境中独立地运行，而不会影响到其它的工作负载。

- ##### 硬件无关性

  因为虚拟化是资源的逻辑表示，不受物理限制的约束，虚拟机与底层的硬件没有直接的绑定关系。因此，尽管目前计算机体系结构呈现出很大的异构性，但只要另一台计算机提供相同的虚拟硬件抽象层，一个虚拟机就可以无缝的迁移过去。

  另外,虚拟硬件抽象层不需要与物理硬件相匹配,因而还可以虚拟出较旧的硬件来兼容旧系统软件。

- ##### 特权功能

  由于虚拟化层处于客户机及客户机操作系统的下面,其具有更高的特权级。在这个层中添加新的功能有如下两个优势。

  (1)新的功能有高特权级,不能被客户机操作系统绕过。

  (2）新的功能不需要了解客户机内部的语义,使其实现上更容易。 

#### C. 应用场景和使用案例

​                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   



### II. 虚拟机的基本原理



![image-20230724200115285](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230724200115285.png)

![image-20230720145027567](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230720145027567.png)

#### A. 虚拟化层和底层硬件 

##### 虚拟化层

- 虚拟化层是虚拟机监控器（VMM）的核心组成部分。虚拟机监控器是虚拟化技术的关键，负责在物理计算机上创建和管理多个虚拟机。
- 虚拟化层充当了虚拟化平台的中间层，位于物理计算机的操作系统之上。它直接与底层硬件交互，并在物理资源之上建立一层抽象，将物理计算机资源虚拟化为多个独立的虚拟机实例。
- 虚拟化层负责虚拟机的创建、配置、启动、停止、销毁和资源调度，以及虚拟机之间的隔离和资源管理。它实现了对底层硬件的虚拟化，为每个虚拟机提供了一个虚拟的计算机环境。

##### 底层硬件

- 底层硬件指的是物理计算机的实际硬件资源，包括CPU、内存、存储、网络接口等。
- 虚拟机监控器通过与底层硬件交互来实现虚拟化。它利用底层硬件提供的虚拟化扩展指令集（如Intel的VT-x和AMD的AMD-V）来增强虚拟化性能和效率。
- 虚拟化层通过对底层硬件的抽象和隔离，为每个虚拟机提供了一个虚拟的硬件环境。每个虚拟机都认为自己独占了一部分底层硬件资源，但实际上这些资源是由虚拟化层进行调度和管理的。

#### B. 宿主机和虚拟机的关系                                                                         

宿主机（Host）：

- 宿主机是指物理计算机，也称为物理主机或托管主机。它是虚拟化环境的基础，是虚拟机监控器（VMM）运行的实际硬件平台。
- 在宿主机上安装并运行虚拟化软件（如VMware、VirtualBox、Hyper-V等），这些虚拟化软件充当虚拟机监控器，负责创建、管理和调度多个虚拟机。
- 宿主机提供了虚拟化层和底层硬件资源，包括CPU、内存、存储、网络等，虚拟化层通过虚拟化技术将这些资源虚拟化为多个独立的虚拟机实例。

虚拟机是在宿主机上创建的，它们之间的关系如下：

- 宿主机提供虚拟化层和底层硬件资源，用于创建和管理多个虚拟机实例。
- 虚拟机运行在宿主机的虚拟化层之上，使用宿主机的硬件资源来执行操作系统和应用程序。
- 宿主机通过虚拟化技术将底层硬件资源虚拟化为多个独立的虚拟机实例，每个虚拟机都认为自己独占了一部分底层硬件资源。
- 多个虚拟机可以在同一台宿主机上同时运行，实现资源的高效利用和硬件资源的复用。

#### C. 虚拟机监视器（Hypervisor）(Virtual Machine Monitor(VMM)虚拟机监视器) 

Hypervisor是运行在物理机之上，主要功能是基于物理资源创建相应的虚拟资源，组成虚拟机，为客户机操作系统提供虚拟的平台。也因此，VMM基本上可以分为两部分：虚拟环境的管理和物理资源的管理。

##### 核心部分

- 处理虚拟化
- 内存虚拟化
- I/O虚拟化

##### 虚拟环境的管理

- 虚拟资源

  处理器虚拟化、内存虚拟化、I/O虚拟化。

- 虚拟环境的调度

  操作系统调度程序的调度单位是进程/线程，VMM 调度程序的调度单位是虚拟处理器。当虚拟处理器被调度到时，VMM调度程序负责将虚拟处理器上下文装载到物理处理器上,然后虚拟处理器所对应的客户机指令开始真正被执行。当时间片用完或者虚拟处理器主动让出,调度程序会被触发。调度程序根据调度策略,挑选下一个虚拟处理器继续运行。

- 虚拟机间的通信机制

  虚拟机间通信机制从实现上来说可以多种多样。通常来说，VMM实现虚拟机间的通信机制,并向虚拟机提供相应的API。虚拟机的客户机操作系统通过调用这些API与其他虚拟机进行通信。这些API可以是事件通知,也可以是内存共享等。在虚拟机间通信机制的实现上,严格的安全权限检查也是必需的,否则虚拟机之间的隔离就会受到影响。另外,VMM除了提供虚拟机之间通信的API外,也提供虚拟机与VMM之间交互的API。

- 虚拟化环境的管理接口

  虚拟机的管理功能也非常重要。可管理性是用户挑选虚拟化产品的重要指标之一。实现上来说,虚拟机的管理功能由上层的管理程序和VMM提供的管理接口组成。VMM需要提供一组完备的管理接口,来支持虚拟环境的创建、删除﹑暂停、查询和迁移等功能。上层的管理程序则通过调用VMM提供的管理接口,为用户提供管理界面。

##### 物理资源的管理

- 处理器管理
- 内存管理
- 中断管理
- 系统时间拥护
- 设备管理

##### 其他模块

- 软件定时器
- 多处理器同步原语
- 调试手段
- 性能采集与分析工具
- 安全机制
- 电源管理

##### 按实现结构分类

- 裸机型

  直接运行在物理设备之上，是一种基于内核的虚拟机。这种类型的Hypervisor所扮演的角色是一种抽象概念的OS。

- 主机型

  运行在宿主机器的操作系统上创建硬件全仿真实例。Hypervisor构建出一整套虚拟硬件平台（CPU/Memory/Storage/Adapter），上面需要你再去安装新的操作系统和需要的应用软件，这样底层和上层的OS就可以完全无关化。



### III. 实现方式 

#### 1、CPU虚拟化

CPU虚拟化需要解决两个问题

如何模拟CPU指令 (所有敏感指令)

敏感指令：可以读写系统关键资源的指令叫做敏感指令。

特权指令：决大多数的敏感指令是特权指令，特权指令只能在处理器的最高特权级 (内核态)执行。

如何让多个VM共享CPU

利用与Native操作系统类似的机制—通过定时器中断，在中断触发时陷入VMM，从而根据调度机制进行调度。

CPU虚拟化：硬件–>VMM(虚拟机监视程序)–>Guest os(虚拟机操作系统)–>app

当Guest OS执行到特殊指令的时候，系统会切换到VMM，让VMM来处理特殊指令

经典虚拟化:基于Power pc cpu架构 Power pc cpu架构和传统的X86架构不同的是指令集的不同，有部分指令无法被虚拟化层拦截（X86架构的16条指令），没有通过虚拟化层的转译，硬件无法识别指令从而会引发一些错误，因此CPU虚拟化分为:全虚、半虚、硬虚


x86架构为操作系统和应用程序提供了四个不同级别的权限来管理对硬件的访问，分别为ring 0，1，2和3。用户程序一般运行在ring 3，操作系统需要直接访问内存和硬件，因此需要在ring 0执行它的特权指令。x86架构的虚拟化需要在操作系统(运行于最高权限的ring 0)之下放置一个提供共享资源的虚拟化层来创建和管理虚拟机。比较糟的是，有些敏感指令在非ring 0下执行时具有不同的语义，因此不能很好地将其虚拟化。在运行时陷入并翻译这些敏感指令和特权指令是一个艰难的挑战，这使得x86架构的虚拟化起初看起来是不可完成的任务。

![image-20230724131756762](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230724131756762.png)

VMware在1998年就攻克了这个挑战，开发了二进制翻译技术使得VMM运行在ring 0以达到隔离和性能的要求，而将操作系统转移到比应用程序所在ring 3权限高和比虚拟机监控器所在ring 0权限低的用户级。基于VMware 20000多客户的安装使用情况以及所形成的广大合作伙伴生态系统，VMware使用二进制翻译的全虚拟化方案已经成为事实上的标准，总的来说业界还没有一个开放的标准来定义和管理虚拟化。每个开发虚拟化解决方案的公司可以用不同的方式应对这个技术上的挑战，提供的解决方案良莠不齐。

正如以下阐述的，目前有三种技术来实现x86架构CPU敏感指令和特权指令的虚拟化，分别为：

. 使用二进制翻译的全虚拟化；

. 操作系统辅助或半虚拟化；

. 硬件辅助的虚拟化(第一代)；

##### A. 全虚拟化（Full Virtualization） 

使用二进制翻译和直接指令执行相结合的技术，VMware可以虚拟化任何基于x86的操作系统。这种方法将内核代码翻译，以便使用一系列作用于虚拟化硬件可达到所需效果的新指令序列替换那些不可虚拟化的指令。同时，用户级的代码直接运行在物理处理器上保证虚拟化的高性能。虚拟机监控器为每个虚拟机提供类似于真实物理系统所具有的服务，如一个虚拟的BIOS，虚拟化设备和虚拟化的内存管理。

![image-20230724132008648](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230724132008648.png)

二进制翻译和直接指令执行相结合的全虚拟化使得虚拟机系统和底下的物理硬件彻底解耦。虚拟机系统没有意识到它是被虚拟化的，因此不需要虚拟机系统做任何的修改。全虚拟化是不需要硬件辅助或操作系统辅助来虚拟化敏感指令和特权指令的唯一方案。hypervisor将操作系统的指令翻译并将结果缓存供之后使用，而用户级指令无需修改就运行，具有和物理机一样的执行速度。

全虚拟化为虚拟机提供最佳的隔离和安全性，使移植变得简单，因为同样的虚拟机系统可运行于虚拟化环境或真实物理硬件上。

二进制翻译技术

![image-20230725172124476](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230725172124476.png)

BT 技术在VMM中开辟一块代码缓存,将代码翻译好放在其中。原始的客户机操作系统代码并不会直接被物理CPU执行,它们以基本块的形式组织,模拟器先将即将执行的基本块翻译成目标代码块,再转人目标代码块执行,再翻译接下来要运行的原始基本块,如图所示。

##### B. 半虚拟化（Para-virtualization） 

就以“alongside virtualization”来说，半虚拟化指的是虚拟机系统和hypervisor通过交互来改善性能和效率。半虚拟化涉及到修改操作系统内核来将不可虚拟化的指令替换为直接与虚拟化层交互的超级调用(hypercalls)。hypervisor同样为其他关键的系统操作如内存管理、中断处理、计时等提供了超级调用接口。

![image-20230724134248750](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230724134248750.png)

半虚拟化和全虚拟化不一样，全虚拟化时未经修改的虚拟机系统不知道自身被虚拟化，系统敏感的调用陷入后再进行二进制翻译。半虚拟化的价值在于更低的虚拟化代价，但是半虚拟化相对全虚拟化的性能优势根据不同的工作负载有很大差别。半虚拟化不支持未经修改的操作系统(如Windows 2000/XP)，因此它的兼容性和可移植性较差。由于半虚拟化需要系统内核的深度修改，在生产环境中，半虚拟化在技术支持和维护上会有很大的问题。开源的Xen项目是半虚拟化的一个例子，它使用一个经过修改的Linux内核来虚拟化处理器，而用另外一个定制的虚拟机系统的设备驱动来虚拟化I/O。

使用二进制翻译来实现虚拟化更复杂更困难，相对来说修改虚拟机系统较容易。

##### C. 硬件辅助虚拟化（Hardware-assisted Virtualization）

硬件厂商迅速拥抱虚拟化并开发出新的硬件特性来简化虚拟化技术。第一代技术包括Intel虚拟化技术(VT-x)和AMD的AMD-V，两者都针对特权指令为CPU添加了一个执行模式，VMM运行在ring 0，同时在新增的根模式下。如图所示，特权和敏感调用自动陷入hypervisor，不再需要二进制翻译或半虚拟化。虚拟机的状态保存在虚拟机控制结构(VMCS，VT-x)或虚拟机控制块(VMCB，AMD-V)中。带有VT和AMD-V的处理器在2006年投入使用，因此新的系统才会带有这些硬件辅助特性。由于hypervisor到虚拟机转换的高代价和僵化的编程模型，目前VMware的二进制翻译技术在很多情况下会比第一代硬性辅助的实现表现更好。第一代硬件辅助虚拟化的实现中，僵化的编程模型使软件在管理hypervisor到虚拟机转换的频率和代价方面失去灵活性。出于此，VMware仅使用了第一代硬件辅助的少数特性，例如在Intel处理器上支持64位虚拟机。

![image-20230724134349881](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230724134349881.png)

#### 2、内存虚拟化

##### 软件方式

##### 影子页表技术

![image-20230726133616541](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726133616541.png)

![image-20230726133605504](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726133605504.png)

##### 硬件实现

在内存虚拟化中，硬件实现是通过处理器中的内存虚拟化扩展来提高虚拟化性能和效率的技术。这些硬件扩展允许虚拟机监视器（VMM，hypervisor）在硬件级别直接管理虚拟机的内存映射，从而减少了软件模拟的开销。

主要的硬件实现方式是使用处理器的内存虚拟化扩展，如Intel的EPT（Extended Page Tables）和AMD的RVI（Rapid Virtualization Indexing）。

##### EPT技术

原理图

![image-20230726141943355](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726141943355.png)

假设现在 Guest 中某个进程需要访问内存，CPU 首先会访问 Guest 中的 CR3 页表来完成 GVA 到 GPA 的转换，如果 GPA 不为空，则 CPU 接着通过 EPT 页表来实现 GPA 到 HPA 的转换（实际上，CPU 会首先查看硬件 EPT TLB 或者缓存，如果没有对应的转换，才会进一步查看 EPT 页表），如果 HPA 为空呢，则 CPU 会抛出 EPT Violation 异常由 VMM 来处理。

如果 GPA 地址为空，即缺页，则 CPU 产生缺页异常，注意，这里，如果是软件实现的方式，则会产生 VM-exit，但是硬件实现方式，并不会发生 VM-exit，而是按照一般的缺页中断处理，这种情况下，也就是交给 Guest 内核的中断处理程序处理。

在中断处理程序中会产生 EXIT_REASON_EPT_VIOLATION，Guest 退出，VMM 截获到该异常后，  分配物理地址并建立 GVA 到 HPA 的映射，并保存到 EPT 中，这样在下次访问的时候就可以完成从 GVA 到 HPA 的转换了。

![image-20230726145018901](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726145018901.png)

#### 3、设备和I/O虚拟化

- I/O全虚拟

  在全虚拟化中，虚拟机不需要修改其操作系统或应用程序，它们可以在没有任何修改的情况下在虚拟化环境中运行。虚拟机监视器（VMM，hypervisor）负责模拟并代理虚拟机对I/O设备的访问请求，将虚拟机中的I/O请求转换为对宿主机的实际物理设备的访问。

  <img src="C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726160310026.png" alt="image-20230726160310026" style="zoom:67%;" />

- I/O半虚拟

  半虚拟化是一种折中的方法。在半虚拟化中，虚拟机监视器与虚拟机中的操作系统和应用程序之间进行合作，虚拟机中的操作系统需要进行修改以使用特定的虚拟化接口。虚拟机中的操作系统通过这些接口与虚拟机监视器进行通信，以实现对I/O设备的访问。

  **<img src="C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726160326026.png" alt="image-20230726160326026" style="zoom:67%;" />**

  针对 I/O 全虚拟化纯软件模拟性能不高这一点，I/O 半虚拟化前进了一步。它提供了一种机制，使得 Guest 端与 Host 端可以建立连接，直接通信，摒弃了截获模拟这种方式，从而获得较高的性能。

  值得注意的有两点：1）采用 I/O 环机制，使得 Guest 端和 Host 端可以共享内存，减少了虚拟机与 VMM 之间的交互；2）采用事件和回调的机制来实现 Guest 与 Host VMM 之间的通信。这样，在进行中断处理时，就可以直接采用事件和回调机制，无需进行上下文切换，减少了开销。

  要实现这种方式， Guest 端和 Host 端需要采用类似于 C/S 的通信方式建立连接，这也就意味着要修改 Guest 和 Host 端操作系统内核相应的代码，使之满足这样的要求。为了描述方便，我们统称 Guest 端为前端，Host 端为后端。

  前后端通常采用的实现方式是驱动的方式，即前后端分别构建通信的驱动模块，前端实现在内核的驱动程序中，后端实现在 qemu 中，然后前后端之间采用共享内存的方式传递数据。

  

- I/O透传

  上面两种虚拟化方式，还是从软件层面上来实现，性能自然不会太高。最好的提高性能的方式还是从硬件上来解决。如果让虚拟机独占一个物理设备，像宿主机一样使用物理设备，那无疑性能是最好的。

  I/O 直通技术就是提出来完成这样一件事的。它通过硬件的辅助可以让虚拟机直接访问物理设备，而不需要通过 VMM 或被 VMM 所截获。

  由于多个虚拟机直接访问物理设备，会涉及到内存的访问，而内存又是共享的，那怎么来隔离各个虚拟机对内存的访问呢，这里就要用到一门技术——IOMMU，简单说，IOMMU 就是用来隔离虚拟机对内存资源访问的。

  I/O 直通技术需要硬件支持才能完成，这方面首选是 Intel 的 VT-d 技术，它通过对芯片级的改造来达到这样的要求，这种方式固然对性能有着质的提升，不需要修改操作系统，移植性也好。

  但该方式也是有一定限制的，这种方式仅限于物理资源丰富的机器，因为这种方式仅仅能满足一个设备分配给一个虚拟机，一旦一个设备被虚拟机占用了，其他虚拟机时无法使用该设备的。

  <img src="C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726162108636.png" alt="image-20230726162108636" style="zoom:67%;" />

  为了解决这个问题，使一个物理设备能被更多的虚拟机所共享。学术界和工业界都对此作了大量的改进，PCI-SIG 发布了 SR-IOV (Single Root I/O Virtualizmion) 规范，其中详细阐述了硬件供应商在多个虚拟机中如何共享单个 I/O 设备硬件。

  SR-IOV标准定义了设备原生共享所需的「软硬件支持」。硬件支持包括芯片组对 SR-IOV 设备的识别，为保证对设备的安全、隔离访问还需要北桥芯片的 VT-d 支持，为保证虚拟机有独立的内存空间，CPU 要支持 IOMMU。软件方面，VMM 将驱动管理权限交给 Guest，Guest 操作系统必须支持 SR-IOV 功能。

  SR-IOV 单独引入了两种软件实体功能：

  - PF（physical function）：包含轻量级的 PCIe 功能，负责管理 SR-IOV 设备的特殊驱动，其主要功能是为 Guest 提供设备访问功能和全局贡献资源配置的功能。
  - VF（virtual function）：包含轻量级的 PCIe 功能。其功能包含三个方面：向虚拟机操作系统提供的接口；数据的发送、接收功能；与 PF 进行通信，完成全局相关操作。

  每个 SR-IOV 设备都可有一个物理功能 PF，并且每个 PF 最多可有 64,000 个与其关联的虚拟功能 VF。

  一般，Guest 通过物理功能 PF 驱动发现设备的 SR-IOV 功能后将包括发送、接收队列在内的物理资源依据 VF 数目划分成多个子集，然后 PF 驱动将这些资源子集抽象成 VF 设备，这样，VF 设备就可以通过某种通信机制分配给虚拟机了。

  ![image-20230726162143052](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20230726162143052.png)

  尽管 I/O 直通技术消除了虚拟机 I/O 中 VMM 干预引起的额外开销，但在 I/O 操作中 I/O 设备会产生大量的中断，出于安全等因素考虑，虚拟机无法直接处理中断，因此中断请求需要由 VMM 安全、隔离地路由至合适的虚拟机。所以，其实实际使用中，都是软硬件虚拟化方式结合使用的。

#### 